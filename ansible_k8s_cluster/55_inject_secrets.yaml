# Working Playbook to inject secrets via ansible vault.
# Currently working on homarr secret to how it can work and get a working sample.

---
- name: Deploy Kubernetes secret using vault variables
  # Target only the first host in the 'k8s_control_plane' group
  # The slice [0] targets the very first item (vmus-test-k8s-01)
  hosts: k8s_control_plane[0] 
  become: yes # Use 'become: yes' if the task requires root/sudo privileges

  # 1. Load your Ansible Vault file
  # The path is relative to the playbook file, 
  # so adjust if your playbook is in a different location.
  vars_files:
    - ansible_vault/dev/homar-vault.yaml

  pre_tasks:
    - name: Check if kubernetes.core collection is installed
      # Note: This is a controller-local check, not run on the remote hosts.
      ansible.builtin.command: ansible-galaxy collection list kubernetes.core
      register: k8s_collection_check
      ignore_errors: yes
      delegate_to: localhost # Run this command on the Semaphore server

    - name: Install kubernetes.core collection if not already present
      # We delegate to localhost (Semaphore) to run the install command.
      ansible.builtin.command: ansible-galaxy collection install kubernetes.core
      when: k8s_collection_check.rc != 0
      delegate_to: localhost

  # --- END OF PRE-TASKS ---

  tasks:
    - name: Ensure Kubernetes secret is created/updated from template
      ansible.builtin.template:
        # Assuming your template is named 'secret_template.yaml.j2' 
        # and is in a 'templates' folder next to the playbook.
        src: templates/55-inject-secrets.yaml.j2 
        # Set the destination path on the remote node for the final YAML file
        dest: /tmp/homar-k8s-secret.yaml 
        owner: root
        group: root
        mode: '0644'

    - name: Apply the Kubernetes secret configuration to the cluster
      # This task typically runs on the control plane node
      kubernetes.core.kubectl:
        # Use a connection to the host itself to run the command
        kubeconfig: /etc/kubernetes/admin.conf # Adjust if needed
        filename: /tmp/homar-k8s-secret.yaml
        state: present
      register: k8s_result
      
    - name: Display result of kubectl command
      ansible.builtin.debug:
        var: k8s_result.stdout_lines