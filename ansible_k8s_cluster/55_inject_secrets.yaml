# Working Playbook to inject secrets via ansible vault.
# Currently working on homarr secret to how it can work and get a working sample.

---
- name: Deploy Kubernetes secret using vault variables
  # Target only the first host in the 'k8s_control_plane' group
  # The slice [0] targets the very first item (vmus-test-k8s-01)
  hosts: k8s_control_plane[0] 
  become: yes # Use 'become: yes' if the task requires root/sudo privileges

  # 1. Load your Ansible Vault file
  # The path is relative to the playbook file, 
  # so adjust if your playbook is in a different location.
  vars_files:
    - ansible_vault/dev/homar-vault.yaml

  tasks:
   # 1. FETCH KUBECONFIG TO RUNNER (File goes to /tmp/kubeconfig/client.config on runner)
    - name: Fetch MicroK8s client config to Controller
      ansible.builtin.fetch:
        src: /var/snap/microk8s/current/credentials/client.config 
        dest: /tmp/kubeconfig/ 
        flat: yes 

    # 2. GENERATE MANIFEST ON RUNNER (We will stage it in /tmp/ instead of /home/levix/.kube)
    - name: Ensure Kubernetes secret is created/updated from template (on Controller runner)
      ansible.builtin.template:
        src: templates/55-inject-secrets.yaml.j2 
        # DESTINATION IS NOW A SAFE /TMP PATH ON THE RUNNER
        dest: /tmp/homar-k8s-secret.yaml 
      delegate_to: localhost 
      become: no
      run_once: true
      connection: local
      vars:
        ansible_remote_tmp: /tmp/ansible-temp

    # 2.5: TEMPORARY DEBUG TASK TO FIND THE RUNNER USER
    - name: Debug - Find current runner user
      ansible.builtin.command: id -un
      delegate_to: localhost
      become: no
      connection: local
      vars:
        # RE-APPLY THE CRITICAL FIXES
        ansible_remote_tmp: /tmp/ansible-temp 
      register: runner_user_info
      run_once: true

    - name: Debug - Print runner user
      ansible.builtin.debug:
        msg: "The Ansible job is running as user: {{ runner_user_info.stdout }}"
      run_once: true

    # 3. APPLY SECRET USING RUNNER'S KUBECONFIG
    - name: Apply the Kubernetes secret configuration to the cluster
      kubernetes.core.k8s:
        kubeconfig: /tmp/kubeconfig/client.config 
        src: /tmp/homar-k8s-secret.yaml
        state: present
      delegate_to: localhost 
      become: no 
      connection: local
      vars:
        ansible_remote_tmp: /tmp/ansible-temp
        # FINAL FIX: POINT ANSIBLE TO THE VIRTUAL ENVIRONMENT
        ansible_python_interpreter: /opt/ansible_venv/bin/python
      register: k8s_result