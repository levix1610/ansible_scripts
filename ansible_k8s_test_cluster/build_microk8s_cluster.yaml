# This is to build out the cluster and join up all the nodes as specified.
# The first 3 nodes are 'control plane' nodes well the last two are worker nodes.

# WORK IN PROGRESS

---
- name: Initialize MicroK8s on the first control plane node
  hosts: k8s_control_plane[0] # user the first server in the list
  become: yes # becomes sudo user
  tasks:
    - name: Generate join command for all other nodes
      ansible.builtin.shell: microk8s add-node --format short  # Will generate join token command
      register: join_token_output # puts the join tokem command in a variable
      run_once: true


- name: Join remaining nodes to the cluster
  hosts: k8s_control_plane[1:], k8s_workers # hosts in inventory it will run on
  become: yes # becomes sudo user
  tasks:
    - name: Get join command from the first control plane node
      ansible.builtin.set_fact: #takes the variable from the task above to run in shell
        join_command_from_control_plane: "{{ hostvars[groups['k8s_control_plane'][0]]['join_token_output'].stdout }}"
      delegate_to: "{{ groups['k8s_control_plane'][0] }}" # Variable was not accessable to the other nodes - this passes it through

    - name: Run join command on other control plane nodes (no worker flag)
      ansible.builtin.shell: "{{ join_command_from_control_plane }}" # Command to run variable in shell on remaind control plane servers
      when: inventory_hostname in groups['k8s_control_plane'] # Goes until inventory list is completed

    - name: Run join command on dedicated worker nodes (with worker flag)
      ansible.builtin.shell: "{{ join_command_from_control_plane }} --worker" # Command to run variable in shell on all worker servers
      when: inventory_hostname in groups['k8s_workers'] # Goes until inventory list is completed


- name: Configure cluster add ons
  hosts: k8s_control_plane[0] # Run the command on the first node
  become: yes # become sudo user
  tasks:
    - name: Enable metrics-server add-on
      ansible.builtin.shell: microk8s enable metrics-server # run shell command to enable metrics-server addon
      run_once: true

    - name: Enable MetalLB add-on with IP address pool
      ansible.builtin.shell: microk8s enable metallb:10.0.100.2-10.0.100.35 # run shell command to enable metalLB with the default IP range
      run_once: true